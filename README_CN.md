# MassFlow

[English](README.md) | ç®€ä½“ä¸­æ–‡

MassFlow æ˜¯ä¸€ä¸ªæ¨¡å—åŒ–çš„é«˜æ€§èƒ½è´¨è°±æˆåƒï¼ˆMSIï¼‰æ•°æ®é¢„å¤„ç†æ¡†æ¶ã€‚å®ƒä¸º MSI ç ”ç©¶æä¾›é«˜æ•ˆçš„æ•°æ®ç®¡ç†ã€å¤„ç†å’Œå¯è§†åŒ–åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½

#### æ•°æ®å¯¼å…¥å’Œå¯¼å‡º
- **æ”¯æŒæ ¼å¼**ï¼š`.h5`ã€`.msi`ã€`.mat`ï¼ˆMATLAB æ ¼å¼ï¼‰
- **æ‰¹é‡å¤„ç†**ï¼šå¯¼å…¥æ•´ä¸ªç›®å½•çš„ MSI æ–‡ä»¶
- **çµæ´»çš„å­˜å‚¨æ¨¡å¼**ï¼š
  - Split æ¨¡å¼ï¼šæ¯ä¸ª m/z å€¼ä¿å­˜ä¸ºå•ç‹¬æ–‡ä»¶
  - Merge æ¨¡å¼ï¼šæ‰€æœ‰æ•°æ®åˆå¹¶åˆ°å•ä¸ªæ–‡ä»¶
- **æ•°æ®è¿‡æ»¤**ï¼šåŠ è½½ç‰¹å®š m/z èŒƒå›´ä»¥å‡å°‘å†…å­˜ä½¿ç”¨
- **å…ƒæ•°æ®ç®¡ç†**ï¼šè‡ªåŠ¨æå–å’Œå­˜å‚¨å…ƒæ•°æ®

#### æ•°æ®ç®¡ç†
- **MSI é¢†åŸŸæ¨¡å‹**ï¼šæä¾›æ¸…æ™°çš„ APIï¼ŒåŒ…å«å…ƒæ•°æ®ã€åˆ‡ç‰‡é˜Ÿåˆ—å’Œå¯é€‰æ•°æ®çŸ©é˜µ
- **å†…å­˜é«˜æ•ˆåŠ è½½**ï¼šé€‰æ‹©æ€§ m/z èŒƒå›´åŠ è½½ä»¥æœ€å°åŒ–å†…å­˜å ç”¨
- **æ•°æ®å½’ä¸€åŒ–**ï¼šé€é€šé“æœ€å°-æœ€å¤§å½’ä¸€åŒ–
- **åŸºç¡€æ©ç ç”Ÿæˆ**ï¼šè‡ªåŠ¨ç”Ÿæˆç»„ç»‡åŒºåŸŸæ©ç 
- **ç¨€ç–æ€§è¿‡æ»¤**ï¼šåŸºäºç¨€ç–æ€§é˜ˆå€¼è¿‡æ»¤é€šé“

#### å¯è§†åŒ–
- **MSI å›¾åƒç»˜åˆ¶**ï¼šæ˜¾ç¤ºæŒ‡å®š m/z èŒƒå›´çš„å›¾åƒ
- **å¯è‡ªå®šä¹‰æ˜¾ç¤º**ï¼šå¯è°ƒèŠ‚é˜ˆå€¼ã€è‰²å›¾å’Œå›¾å½¢å°ºå¯¸
- **æ‰¹é‡å¯è§†åŒ–**ï¼šåœ¨æŒ‡å®šèŒƒå›´å†…ç»˜åˆ¶å¤šä¸ªå›¾åƒ
- **å¯¼å‡ºæ”¯æŒ**ï¼šä¿å­˜å›¾åƒåˆ°æ–‡ä»¶æˆ–äº¤äº’å¼æ˜¾ç¤º

#### ä¸“ç”¨å¤„ç†å™¨
- **MSIDataManager**ï¼šç”¨äº `.h5`/`.msi` æ–‡ä»¶çš„é€šç”¨æ•°æ®ç®¡ç†å™¨
- **MSIDataManagerZYS**ï¼šç”¨äº MATLAB `.mat` æ ¼å¼çš„ä¸“ç”¨å¤„ç†å™¨ï¼Œå…·æœ‰è‡ªå®šä¹‰é¢„å¤„ç†åŠŸèƒ½

### ğŸ“‹ è®¡åˆ’åŠŸèƒ½ï¼ˆTODOï¼‰

#### æ•°æ®å¯¼å…¥
- imzML æ ¼å¼æ”¯æŒ
- mzML æ ¼å¼æ”¯æŒ
- Bruker `.d` æ ¼å¼æ”¯æŒ
- Agilent `.bd` æ ¼å¼æ”¯æŒ

#### åŸºçº¿æ ¡æ­£
ä¾‹å¦‚ï¼šTopHat æ»¤æ³¢å™¨

#### å»å™ªä¸å¹³æ»‘

#### å³°æ£€æµ‹

#### å³°å¯¹é½

#### å½’ä¸€åŒ–
- æ€»ç¦»å­æµï¼ˆTICï¼‰
- ä¸­ä½æ•°å½’ä¸€åŒ–
- å‚è€ƒç¦»å­å½’ä¸€åŒ–
- åˆ†ç®±ï¼ˆé‡é‡‡æ ·å’Œå…‰è°±åˆ†ç®±ï¼‰

## å®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/NeoNexusX/MassFlow.git
cd MassFlow

# å®‰è£…ä¾èµ–
pip install numpy h5py matplotlib pympler
```

## å¿«é€Ÿå¼€å§‹

### ç¤ºä¾‹ 1ï¼šåŠ è½½å®Œæ•´ MSI æ•°æ®

```python
from module.msi_data_manager import MSIDataManager
from module.msi_module import MSI

# Create MSI instance
msi = MSI(name='example1', version=1.0, mask=None, need_base_mask=True)

# Initialize data manager
msi_dm = MSIDataManager(msi, filepath="./data/your_data.mat")

# Load all data
msi_dm.load_full_data_from_file()

# Inspect data
msi_dm.inspect_data()
```

### ç¤ºä¾‹ 2ï¼šåŠ è½½ç‰¹å®š m/z èŒƒå›´

```python
# Load only m/z values between 101 and 102
msi2 = MSI(name='example2', version=1.0, mask=None, need_base_mask=True)
msi_dm2 = MSIDataManager(msi2, target_mz_range=[101, 102], filepath="./data/your_data.mat")
msi_dm2.load_full_data_from_file()

# Plot images in the loaded range
msi2.plot_msi()
```

### ç¤ºä¾‹ 3ï¼šå¤„ç† MATLAB .mat æ–‡ä»¶

```python
from module.msi_data_manager_zys import MSIDataManagerZYS

# Create MSI instance for .mat file
msi3 = MSI(name='20250329_sample', version=1.0, mask=None, need_base_mask=True)

# Initialize ZYS data manager
msi_dm_zys = MSIDataManagerZYS(msi3, filepath="./data/sample.mat")

# Load and rebuild data
msi_dm_zys.load_data_from_zys_mat()
msi_dm_zys.rebuild_hdf5_file_from_zys()

# Plot specific m/z range
msi3.plot_msi(target_mz_range=[100, 150])
```

### ç¤ºä¾‹ 4ï¼šå¯¼å‡ºæ•°æ®

```python
# Export as merged file
msi_dm_zys.write2local(mode='merge', output_fold='./data')

# Export as split files (one file per m/z)
msi_dm_zys.write2local(mode='split')
```

### ç¤ºä¾‹ 5ï¼šæŸ¥è¯¢ç‰¹å®š m/z å€¼

```python
# Get MSI slices for a specific m/z value
msi_list = msi3.get_msi_by_mz(mz_value_min=88.1122, tol=1e-3)
image = msi_list[0].msroi.T
base_mask = msi_list[0].base_mask.T
```

## é¡¹ç›®ç»“æ„

```
MassFlow/
â”œâ”€â”€ module/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ msi_module.py              # æ ¸å¿ƒ MSI é¢†åŸŸæ¨¡å‹
â”‚   â”œâ”€â”€ msi_data_manager.py         # é€šç”¨æ•°æ®ç®¡ç†å™¨
â”‚   â””â”€â”€ msi_data_manager_zys.py     # MATLAB .mat æ ¼å¼å¤„ç†å™¨
â”œâ”€â”€ example.py                       # ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ README.md                        # è‹±æ–‡æ–‡æ¡£
â”œâ”€â”€ README_CN.md                     # ä¸­æ–‡æ–‡æ¡£
â””â”€â”€ LICENSE                          # GNU GPL v3 è®¸å¯è¯
```

## æ ¸å¿ƒç»„ä»¶

### MSI ç±»
ä¸»è¦é¢†åŸŸæ¨¡å‹ï¼Œå°è£…äº†ï¼š
- å…ƒæ•°æ®ç®¡ç†
- MSI åˆ‡ç‰‡é˜Ÿåˆ—
- æ•°æ®çŸ©é˜µå­˜å‚¨
- æŸ¥è¯¢å’Œå¯è§†åŒ–æ–¹æ³•

### MSIDataManager
é€šç”¨æ•°æ®ç®¡ç†å™¨ï¼Œæ”¯æŒï¼š
- `.h5` å’Œ `.msi` æ–‡ä»¶æ ¼å¼
- ä»ç›®å½•æ‰¹é‡å¯¼å…¥
- Split/Merge å¯¼å‡ºæ¨¡å¼
- m/z èŒƒå›´è¿‡æ»¤

### MSIDataManagerZYS
MATLAB `.mat` æ–‡ä»¶çš„ä¸“ç”¨ç®¡ç†å™¨ï¼Œå…·æœ‰ï¼š
- è‡ªå®šä¹‰æ•°æ®ç»“æ„å¤„ç†
- é€é€šé“å½’ä¸€åŒ–
- åŸºäºç¨€ç–æ€§çš„è¿‡æ»¤
- HDF5 è½¬æ¢åŠŸèƒ½

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ GNU é€šç”¨å…¬å…±è®¸å¯è¯ v3.0 - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## å‚è€ƒèµ„æ–™

- [MSI æ•°æ®å¤„ç†å·¥ä½œæµç¨‹](https://pleinelune-r.github.io/2025/08/05/MSI%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/)
- [Cardinal MSI](https://cardinalmsi.org/)
- [Cardinal GitHub ä»“åº“](https://github.com/kuwisdelu/Cardinal/tree/devel/R)
- [MATLAB: é¢„å¤„ç†åŸå§‹è´¨è°±æ•°æ®](https://www.mathworks.com/help/bioinfo/ug/preprocessing-raw-mass-spectrometry-data.html)
- [è´¨è°±æˆåƒé¢„å¤„ç†ç»¼è¿°](https://www.sciencedirect.com/science/article/pii/S0169743921001015)
- [PyOpenMS æ–‡æ¡£](https://pyopenms.readthedocs.io/en/latest/user_guide/background.html#why-use-openms)
- [MSI åˆ†ææœ€æ–°è¿›å±•](https://pubs.acs.org/doi/10.1021/jasms.4c00314)

## è´¡çŒ®

æ¬¢è¿è´¡çŒ®ï¼è¯·éšæ—¶æäº¤ Pull Requestã€‚

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜å’Œéœ€è¦æ”¯æŒï¼Œè¯·åœ¨ GitHub ä»“åº“ä¸­æäº¤ issueã€‚
